var SCREEN_WIDTH=640,SCREEN_CENTER_X=320,SCREEN_HEIGHT=960,SCREEN_CENTER_Y=480,Axis={x:new THREE.Vector3(1,0,0).normalize(),y:new THREE.Vector3(0,1,0).normalize(),z:new THREE.Vector3(0,0,1).normalize()};threeext={extention:function(){THREE.$extend({$extend:function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].copy(t[s]):e[s]=t[s]},this),e},$add:function(e,t){var i=Array.prototype.slice.call(arguments);return i.shift(),Array.prototype.forEach.call(i,function(i){for(var s in i)t[s]||(e[s]&&t[s]&&t[s].className&&"THREE."===t[s].className.substr(0,6)?e[s].add(t[s]):e[s]+=t[s])},this),e}}),THREE.Mesh.prototype.$safe({rotate:function(e,t,i){this.quaternion.rotate(e,t,i)},move:function(e){return this.position.x=e.x,this.position.y=e.y,this.position.z=e.z,this}}),THREE.Vector3.prototype.$safe({className:"THREE.Vector3"}),THREE.Quaternion.prototype.$safe({className:"THREE.Quaternion",rotate:function(e,t,i){if("THREE.Quaternion"===e.className){var s=e.clone();s.multiply(this.clone()),this.copy(s)}else this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,e)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,t)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,i));return this}}),THREE.PerspectiveCamera.prototype.$safe({rotate:function(e){var t=e.clone();t.multiply(this.quaternion.clone()),this.quaternion.copy(t)},move:function(e){this.position.x=e.x,this.position.y=e.y,this.position.z=e.z}})}},phina.define("fly.SimpleUpdater",{superClass:"phina.app.Element",init:function(){this.superInit(),this.elements=[]},update:function(){for(var e=0;e<this.elements.length;e++)this.elements[e].update()},get:function(e){return this.elements[e]},remove:function(e){this.elements.splice(e,1)},count:function(e){return this.elements.length}}),phina.define("fly.DirectionShape",{superClass:"phina.display.Shape",init:function(e){e={}.$safe(e,{backgroundColor:"transparent",fill:"#ff5050",stroke:"#aaa",strokeWidth:2,width:16,height:32}),this.superInit(e)},render:function(e){e.clearColor(this.backgroundColor),e.transformCenter(),this.fill&&(e.fillStyle=this.fill,e.beginPath(),e.moveTo(0,this.height),e.lineTo(this.width,-this.height),e.lineTo(-this.width,-this.height),e.closePath(),e.fill()),this.isStrokable()&&(e.lineWidth=this.strokeWidth,e.strokeStyle=this.stroke,e.beginPath(),e.moveTo(0,this.height),e.lineTo(this.width,-this.height),e.lineTo(-this.width,-this.height),e.closePath(),e.stroke())}}),phina.define("fly.asset.ThreeJSON",{superClass:"phina.asset.Asset",data:null,init:function(){this.superInit()},_load:function(e){var t=this;(new THREE.JSONLoader).load(this.src,function(i,s){t.data=new THREE.Mesh(i,new THREE.MeshFaceMaterial(s)),e(t)})},get:function(){return this.data.clone()}}),phina.define("fly.asset.ThreeTexture",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this;(new THREE.TextureLoader).load(this.src,function(i){t._asset=i,e(t)})},get:function(){var e=this._asset.clone();return e.needsUpdate=!0,e}}),phina.define("fly.asset.ThreeCubeTex",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this,s=this.src.split(" ",2),n=[];for(i=0;i<6;i++)n[i]=s[0]+i+s[1];(new THREE.CubeTextureLoader).load(n,function(i){var s=THREE.ShaderLib.cube;s.uniforms.tCube.value=i,t._asset=new THREE.Mesh(new THREE.BoxGeometry(1e4,1e4,1e4),new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:s.uniforms,depthWrite:!1,side:THREE.BackSide})),e(t)})},get:function(){return this._asset.clone()}}),phina.define("fly.asset.Text",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var t=this,i=new XMLHttpRequest;i.open("GET",this.src),i.onreadystatechange=function(){4===i.readyState&&(-1!==[200,201,0].indexOf(i.status)?(t._asset=i.response,e(t)):(t.loadError=!0,t.flare("loaderror"),404===i.status?(t.notFound=!0,t.flare("notfound")):(t.serverError=!0,t.flare("servererror")),reject(t)))},i.send(null)},get:function(){return this._asset}}),phina.define("fly.asset.JSON",{superClass:"phina.asset.Asset",_asset:{},init:function(){this.superInit()},_load:function(e){var t=this,i=fly.asset.Text();i.load(this.src).then(function(){this._asset=JSON.parse(i.get()),e(t)}.bind(this))},get:function(){return this._asset}}),phina.define("fly.asset.Stage",{superClass:"phina.asset.Asset",data:[],init:function(){this.superInit()},_load:function(e){var t=this,i=fly.asset.JSON();i.load(this.src).then(function(){var s=i.get();s.$safe({enemys:[],winds:[],messages:[],goal:{}});for(var n=0;n<s.enemys.length;n++)s.enemys[n].$safe({position:{},rotation:{},option:{},autospawn:{},random:{},killmes:{}}),s.enemys[n].position.$safe({x:0,y:0,z:0}),s.enemys[n].rotation.$safe({x:0,y:0,z:0,cx:0,cy:0,cz:0}),s.enemys[n].autospawn.$safe({time:0,progress:0,random:{}}),s.enemys[n].autospawn.random.$safe({x:0,y:0,z:0}),s.enemys[n].killmes.$safe({time:0,text:""}),s.enemys[n].option.$safe({position:new THREE.Vector3(s.enemys[n].position.x,s.enemys[n].position.y,s.enemys[n].position.z),quaternion:(new THREE.Quaternion).rotate(s.enemys[n].rotation.x,s.enemys[n].rotation.y,s.enemys[n].rotation.z),c:(new THREE.Quaternion).rotate(s.enemys[n].rotation.cx,s.enemys[n].rotation.cy,s.enemys[n].rotation.cz)});for(var n=0;n<s.winds.length;n++)s.winds[n].$safe({v:.2,x:0,y:0,color:[0,0,0]}),s.winds[n].position=new THREE.Vector2(s.winds[n].x,s.winds[n].y),s.winds[n].c=s.winds[n].color[0]<<16|s.winds[n].color[1]<<8|s.winds[n].color[2];for(var n=0;n<s.messages.length;n++)s.messages[n].$safe({time:0,text:""});s.goal.$safe({x:0,y:0,z:0,size:100}),this.data=s,e(t)}.bind(this))},get:function(){return this.data}}),phina.asset.AssetLoader.assetLoadFunctions.threejson=function(e,t){var i=fly.asset.ThreeJSON(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threetexture=function(e,t){var i=fly.asset.ThreeTexture(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.threecubetex=function(e,t){var i=fly.asset.ThreeCubeTex(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.text=function(e,t){var i=fly.asset.Text(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.json=function(e,t){var i=fly.asset.JSON(),s=i.load(t);return s},phina.asset.AssetLoader.assetLoadFunctions.stage=function(e,t){var i=fly.asset.Stage(),s=i.load(t);return s},fly.colCup2D3=function(e,t,i,s,n){var a=t.clone().sub(e),o=s.clone().multiplyScalar(i.clone().dot(s)/s.clone().dot(s)).sub(i),r=o.clone().dot(o);if(1e-5>r){var h=t.clone().sub(e).length();h=Math.min(h,t.clone().add(s).sub(e).length()),h=Math.min(h,t.clone().sub(e.clone().add(i)).length()),h=Math.min(h,t.clone().add(s).sub(e.clone().add(i)).length());var l=t.clone().add(s.multiplyScalar(a.clone().dot(s)/s.clone().dot(s)*-1)),d=Math.min(h,l.sub(e).length())}else var p=s.clone().dot(s),u=Math.clamp(o.clone().dot(a.clone().dot(s)/p*s.clone().sub(a))/r,0,1),c=Math.clamp(i.clone().multiplyScalar(u).sub(a).dot(s)/p,0,1),d=t.clone().add(s.clone().multiplyScalar(c)).sub(e.clone().add(i.clone().multiplyScalar(u))).length();return n>=d},phina.define("fly.EffectManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.explodeManager=fly.ExplodeManager(e).addChildTo(this),this.rayManager=fly.RayManager(e).addChildTo(this),this.threescene=e},explode:function(e,t,i){return this.explodeManager.explode(e,t,i)},ray:function(e,t,i,s,n,a){return this.rayManager.ray(e,t,i,s,n,a)}}),phina.define("fly.ExplodeManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},explode:function(e,t,i){var s=new THREE.ShaderMaterial({transparent:!0,uniforms:{tExplosion:{type:"t",value:phina.asset.AssetManager.get("threetexture","explode").get()},time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","expvertexshader").get(),fragmentShader:phina.asset.AssetManager.get("text","expfragshader").get()}),n=new THREE.Mesh(new THREE.IcosahedronGeometry(20,2),s).$safe({time:i,timeMax:i}).$safe({time:10,timeMax:10,update:function(){this.time--,s.uniforms.time.value+=.015*Math.random(),s.uniforms.alpha.value=this.time/this.timeMax}});return n.move(e),n.scale.set(t,t,t),this.threescene.add(n),this.elements.push(n),n},update:function(){for(var e=0;e<this.elements.length;e++)this.get(e).update(),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),e--)}}),phina.define("fly.RayManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},ray:function(e,t,i,s,n,a){var o=new THREE.Mesh(new THREE.SphereGeometry(s,20,10,0,2*Math.PI,0,Math.PI/2));o.position.set(0,-500,0);var r=new THREE.Mesh(new THREE.CylinderGeometry(s,s,1e3,20,10),new THREE.MeshBasicMaterial({color:t,opacity:i,transparent:!0})).$safe({time:a,timeMax:a,generator:e,length:500+n,update:function(){this.time--}});return r.geometry.merge(o.geometry),this.threescene.add(r),this.elements.push(r),r},update:function(){for(var e=0;e<this.count();e++)this.get(e).update(),this.get(e).move(this.get(e).generator.position.clone().add(Axis.z.clone().applyQuaternion(this.get(e).generator.quaternion).setLength(this.get(e).length))),this.get(e).quaternion.copy((new THREE.Quaternion).setFromAxisAngle(Axis.x,Math.PI/2)),this.get(e).quaternion.rotate(this.get(e).generator.quaternion),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),e--)}}),phina.define("fly.EnemyManager",{superClass:"fly.SimpleUpdater",definedenemy:[],enemyraders:[],groups:[],init:function(e,t,i,s){this.superInit(),this.scene=e,this.threescene=t,this.gauge_boss_h=i,this.message=s,this.effectmanager=new fly.EffectManager(t).addChildTo(this)},defineEnemy:function(e){this.definedenemy[e]={mesh:phina.asset.AssetManager.get("threejson",e).get(),routine:this.enemys[e].routine.$safe({hp:5,size:1,v:0,c:new THREE.Quaternion,time:0,update:function(){}}),autospawn:(this.enemys[e].autospawn||{}).$safe({rep:1,options:{}})}},createEnemy:function(e,t,i,s,n){if(n){var a=function(o){o.progress>n&&(this.createEnemy(e,t,i,s),this.off("frame",a))}.bind(this);this.on("frame",a)}else{if(!s){var o=this.definedenemy[e].mesh.clone();THREE.$extend(o,this.definedenemy[e].routine),THREE.$extend(o,t),o.group=i,this.threescene.add(o),this.elements.push(o);var r=phina.display.CircleShape({radius:3,fill:"hsla(0, 80%, 60%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).addChildTo(this.scene),h=this.flyer.position.x/15-o.position.x/15,l=this.flyer.position.z/15-o.position.z/15,d=Math.min(Math.sqrt(Math.pow(h,2)+Math.pow(l,2)),75),p=Math.atan2(h,l)-this.flyer.myrot.y+(Math.abs(this.flyer.myrot.x)>Math.PI/2&&Math.abs(this.flyer.myrot.x)<1.5*Math.PI?Math.PI:0);return r.setPosition(SCREEN_WIDTH-100+Math.sin(p)*d,SCREEN_HEIGHT-100+Math.cos(p)*d),this.enemyraders.push(r),t.boss&&(this.scene.bosscoming=!0,this.scene.boss=o,this.gauge_boss_h.value=o.hp,this.gauge_boss_h.maxValue=o.hp),o}this.on("frame"+(this.scene.frame+s),function(){this.createEnemy(e,t,i)}.bind(this))}},createEnemyMulti:function(e,t,i,s){for(var n=i.$safe(this.definedenemy[e].autospawn),a=0;a<n.rep;a++){var o={position:new THREE.Vector3};THREE.$extend(o,t),this.groups.push({num:n.rep,message:s}),this.createEnemy(e,o,this.groups.last,n.time,n.progress),n.delay&&(n.time+=n.delay),THREE.$add(t,n.options),t.position.add(new THREE.Vector3(Math.random()*n.random.x*2-n.random.x,Math.random()*n.random.y*2-n.random.y,Math.random()*n.random.z*2-n.random.z))}},update:function(){for(var e=0;e<this.count();e++){this.get(e).update(this);var t=this.flyer.position.x/15-this.get(e).position.x/15,i=this.flyer.position.z/15-this.get(e).position.z/15,s=Math.min(Math.sqrt(Math.pow(t,2)+Math.pow(i,2)),75),n=Math.atan2(t,i)-this.flyer.myrot.y+(Math.abs(this.flyer.myrot.x)>Math.PI/2&&Math.abs(this.flyer.myrot.x)<1.5*Math.PI?Math.PI:0);this.enemyraders[e].setPosition(SCREEN_WIDTH-100+Math.sin(n)*s,SCREEN_HEIGHT-100+Math.cos(n)*s),this.get(e).hp<=0&&(this.removeEnemy(e),e--)}},removeEnemy:function(e){if(this.effectmanager.explode(this.get(e).position,this.get(e).size,this.get(e).explodeTime),this.scene.score+=this.get(e).size,this.get(e).group.num--,0===this.get(e).group.num){var t=this.get(e).group.message.text;""!==t&&(this.on("frame"+(this.scene.frame+(this.get(e).group.message.time-5)),function(){this.message.text=""}.bind(this)),this.on("frame"+(this.scene.frame+this.get(e).group.message.time),function(){this.message.text=t}.bind(this)))}this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),this.enemyraders[e].remove(),this.enemyraders.splice(e,1)},enemys:{enem1:{filename:"enem-1",routine:{v:.6,chase:0,duration:100,mindist:0,update:function(e){if(e.flyer.position.equals(this.position)||0===this.chase||0===this.mindist)this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v);else{var t=e.flyer.position.clone().sub(this.position.clone()),i=this.v*Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1);t.normalize(),this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),i)}this.time%this.duration===0&&e.enmBulletManager.createBullet({position:this.position,quaternion:this.quaternion,v:2,atk:70}),this.quaternion.rotate(this.c),this.time++}},autospawn:{rep:6,delay:15}},enem2:{filename:"enem-2",routine:{hp:45,v:1,size:15,chase:.1,mindist:500,duration:15,explodeTime:30,update:function(e){if(!e.flyer.position.equals(this.position)){var t=e.flyer.position.clone().sub(this.position.clone()),i=this.v*Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1);t.normalize(),this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),i)}this.time%this.duration===0&&e.enmBulletManager.createBullet({position:this.position,quaternion:this.quaternion,v:3,size:1.5,atk:100}),this.time++}}},enem3:{filename:"enem-3",routine:{hp:500,v:.25,size:30,duration:3,r:.1,explodeTime:30,scale:new THREE.Vector3(2,2,2),update:function(e){this.rotate(this.c);var t=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(this.rotate((new THREE.Quaternion).setFromAxisAngle(t,this.r)),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.duration===0){var i=this.quaternion.clone().rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,Math.PI/2));e.enmBulletManager.createBullet({position:this.position,quaternion:this.quaternion.clone().rotate((new THREE.Quaternion).setFromAxisAngle(i,Math.PI*(this.time%(8*this.duration))/this.duration/8)),size:.5,atk:50})}this.time++}}}}}),phina.define("fly.BulletManager",{superClass:"fly.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e,this.bullet=phina.asset.AssetManager.get("threejson","bullet").get()},createBullet:function(e){var t=this.bullet.clone();return THREE.$extend(t,e).$safe({v:1,size:1,atk:1,update:function(){this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}}),this.threescene.add(t),this.elements.push(t),t},update:function(){for(var e=0;e<this.count();e++)this.get(e).update()},removeBullet:function(e){this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1)}}),phina.define("fly.WindManager",{superClass:"fly.SimpleUpdater",time:0,flyerposy:0,init:function(e){this.superInit(),this.threescene=e},createWind:function(e,t){var i={v:.2,size:100,position:new THREE.Vector2,winds:[],update:function(){}}.$extend(e);i.mesh=THREE.$extend(new THREE.Mesh(new THREE.RingGeometry(i.size-.4,i.size,50,5),new THREE.MeshBasicMaterial({color:t,side:THREE.DoubleSide})),{position:new THREE.Vector3(i.position.x,0,i.position.y)});for(var s=-1e4*Math.sign(i.v);Math.abs(s)<=1e4;s+=300*i.v)i.winds.push(i.mesh.clone()),i.winds.last.rotate(Math.PI/2,0,0),i.winds.last.position.y=this.flyerposy+s,this.threescene.add(i.winds.last);return this.elements.push(i),i},update:function(){for(var e=0;e<this.count();e++){this.time%30===0&&(this.get(e).winds.push(this.get(e).mesh.clone()),this.get(e).winds.last.rotate(Math.PI/2,0,0),this.get(e).winds.last.position.y=this.flyerposy-1e4*Math.sign(this.get(e).v),this.threescene.add(this.get(e).winds.last)),this.get(e).winds.first&&this.get(e).winds.first.parent&&Math.abs(this.get(e).winds.first.position.y-this.flyerposy)>1e4&&this.get(e).winds.first.parent.remove(this.get(e).winds.first);for(var t=0;t<this.get(e).winds.length;t++)this.get(e).winds[t].position.y+=10*this.get(e).v}this.time++},removeWind:function(e){for(var t=0;t<this.get(e).winds.length;t++)this.get(e).winds[t].parent.remove(this.get(e).winds[t]);this.elements.splice(e,1)}}),phina.define("fly.LoadingScene",{superClass:"phina.game.LoadingScene",init:function(e){e=(e||{}).$safe(fly.LoadingScene.defaults).$safe(phina.game.LoadingScene.defaults),this.superInit(e),this.gauge.animationTime=e.animationtime},_static:{defaults:{animationtime:500}}}),phina.define("fly.SplashLoadingScene",{superClass:"phina.display.CanvasScene",init:function(e){e=(e||{}).$safe(phina.game.LoadingScene.defaults),this.superInit(e);var t=phina.asset.Texture();t.load(phina.game.SplashScene.defaults.imageURL).then(function(){this.sprite=phina.display.Sprite(this.texture).addChildTo(this),this.sprite.setPosition(this.gridX.center(),this.gridY.center()),this.sprite.alpha=0,this.sprite.tweener.clear().to({alpha:1},500,"easeOutCubic").wait(1e3).to({alpha:0},500,"easeOutCubic").wait(250).call(function(){this.sprite.remove()},this)}.bind(this)),this.texture=t;var i=phina.asset.AssetLoader();i.onload=function(e){this.app.popScene()}.bind(this),i.load(e.assets)}}),phina.define("fly.SceneLoadingScene",{superClass:"phina.display.CanvasScene",init:function(e){e=(e||{}).$safe(fly.SceneLoadingScene.defaults),this.superInit(e),this.options=e,this.loadprogress=0,this.loadfrequenry=0},load:function(e){this.label=phina.display.Label({text:"Loading... 0%",fill:"hsla(0, 0%, 0%, 0.6)",fontSize:15}).addChildTo(this).setPosition(SCREEN_CENTER_X,SCREEN_CENTER_Y);for(var t=0;t<e.length;t++)for(var i=0;i<e[t].length;i++)this.loadfrequenry++;var s=function(){a=[];for(var t=0;t<e[n].length;t++)(function(){var i=phina.util.Flow(e[n][t].bind(this));i.then(function(){this.label.text="Loading... "+ ++this.loadprogress/this.loadfrequenry*100+"%",this.loadprogress===this.loadfrequenry&&this.removeChild(this.label)}.bind(this)),a.push(i)}).bind(this)()}.bind(this),n=0,a=[];for(s(),t=1;t<e.length;t++){var n=t;phina.util.Flow.all(a).then(s)}}}),phina.define("fly.TitleScene",{superClass:"phina.game.TitleScene",bgbright:64,init:function(e){this.superInit(e),this.fromJSON({children:{messageLabel:{className:"phina.display.Label",arguments:{text:e.message,fill:e.fontColor,stroke:!1,fontSize:24},x:this.gridX.center(),y:this.gridY.span(12)}}}),this.on("pointstart",function(){this.clicked=!0})},update:function(){this.clicked&&(100===this.bgbright&&this.exit(),this.bgbright+=4,this.backgroundColor="hsl(200, 80%, "+this.bgbright+"%)")}}),phina.define("fly.GameOverScene",{superClass:"phina.display.CanvasScene",init:function(e){this.superInit(e),e=(e||{}).$safe(phina.game.ResultScene.defaults);e.message.format(e);this.backgroundColor=e.backgroundColor,this.fromJSON({children:{scoreText:{className:"phina.display.Label",arguments:{text:"score",fill:e.fontColor,stroke:null,fontSize:48},x:this.gridX.center(),y:this.gridY.span(4)},scoreLabel:{className:"phina.display.Label",arguments:{text:""+e.score,fill:e.fontColor,stroke:null,fontSize:72},x:this.gridX.center(),y:this.gridY.span(6)},playButton:{className:"phina.ui.Button",arguments:[{text:"retry",width:144,height:144,fontSize:45,cornerRadius:72}],x:this.gridX.center(),y:this.gridY.span(12),interactive:!0,onpush:function(){this.exit("main")}.bind(this)}}})}}),phina.define("fly.MainScene",{superClass:"fly.SceneLoadingScene",frame:0,stage:"arcade",difficulty:1,progress:0,score:0,init:function(e){e.stage&&(this.stage=e.stage),e.difficulty&&(this.difficulty=e.difficulty),this.superInit();var t=phina.display.ThreeLayer({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),i=phina.display.CircleShape({radius:75,fill:"hsla(0, 0%, 30%, 0.5)",stroke:null}),s=fly.DirectionShape({fill:"hsla(0, 50%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1,width:2.5,height:4}),n=[],a=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(255, 64, 64, 0.3)",value:1e3,maxValue:1e3,strokeWidth:1,width:128,height:16}),o=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(64, 64, 255, 0.3)",value:1e3,maxValue:1e3,strokeWidth:1,width:128,height:16}),r=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(200, 16, 16, 0.3)",strokeWidth:1,width:SCREEN_WIDTH/1.2,height:16}),h=phina.display.RectangleShape({fill:"hsla(0, 0%, 30%, 0.5)",stroke:"hsla(0, 0%, 30%, 0.25)",strokeWidth:1,cornerRadius:5,width:SCREEN_WIDTH/5,height:SCREEN_HEIGHT/12}),l=phina.display.Label({text:"",fontSize:23,fill:"hsla(0, 0%, 0%, 0.6)",align:"left"}),d=phina.display.Label({text:"speed: 1",fontSize:20,fill:"hsla(0, 0%, 0%, 0.6)"}),p=fly.EnemyManager(this,t.scene,r,l),u=p.effectmanager,c=fly.BulletManager(t.scene);p.enmBulletManager=c;var m,f=fly.WindManager(t.scene),g=phina.asset.AssetManager.get("threejson","fighter").get(),E=phina.asset.AssetManager.get("threecubetex","skybox").get(),y=new THREE.Mesh(new THREE.PlaneGeometry(1e4,1e4),new THREE.MeshBasicMaterial({map:phina.asset.AssetManager.get("threetexture","plane").get()}));this.load([[function(e){g.position.y=1e3,g.transparent=!0,g.opacity=.3,g.$safe({speeds:[.1,.25,.45,.95],myrot:{x:0,y:0,z1:0,z2:0},row:0,yo:0,v:0,s1c:0,s2c:0,e:1e3,hp:1e3,speed:0,ups:15e-5,av:new THREE.Vector3,sub1id:0,sub2id:1,update:function(e,t,i){var s=0;if(this.v+=.05,s=e.x-SCREEN_CENTER_X,this.myrot.z1+=8e-5*s,this.yo+=8e-5*s,this.row+=(e.y-SCREEN_CENTER_Y)*this.ups,e.getPointing()&&(this.e--,this.v+=this.speeds[this.speed]),t.getKeyDown(68)&&(this.speed++,this.speed%=4,d.text="speed: "+(this.speed+1)),this.myrot.x+=.1*this.row,this.myrot.y-=.1*this.yo,this.myrot.x%=2*Math.PI,this.quaternion.copy(new THREE.Quaternion),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,this.myrot.z1+this.myrot.z2)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,this.myrot.x)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,this.myrot.y)),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.position.add(this.av),this.av.multiplyScalar(.98),this.myrot.z1*=.95,this.locked=t.getKey(16),t.getKeyDown(16)&&(this.lock=Math.abs(this.myrot.x)<Math.PI/2||Math.abs(this.myrot.x)>1.5*Math.PI),(this.locked?this.lock:Math.abs(this.myrot.x)<Math.PI/2||Math.abs(this.myrot.x)>1.5*Math.PI)?(this.ups<15e-5&&(this.ups+=1e-5),this.myrot.z2*=.95):(this.ups>-15e-5&&(this.ups-=1e-5),this.myrot.z2+=.05*(Math.PI-this.myrot.z2)),this.yo*=.95,this.row*=.9,this.v*=.98-6e-5*Math.abs(s)-(t.getKey(86)?.05:0),this.e>0){if(t.getKey(90)&&0===this.s1c){this.e-=2;var n=this.quaternion.clone();n.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,.06*Math.random()-.03)),n.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,.06*Math.random()-.03));var r=this.quaternion.clone();r.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,.06*Math.random()-.03)),r.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,.06*Math.random()-.03)),this.attack(n,i),this.attack(r,i)}t.getKeyDown(88)&&0===this.s1c&&this.sub[this.sub1id](),t.getKeyDown(67)&&0===this.s2c&&this.sub[this.sub2id](),this.rgl>0&&(this.rgl--,this.beam(30,2,15,0,i)),this.brl>0&&(this.brl--,this.beam(25,3,25,30,i))}this.s1c>0&&this.s1c--,this.s2c>0&&this.s2c--,o.value=this.e,this.e<1e3&&(this.e+=4),a.value=this.hp;for(var h=0;h<f.elements.length;h++){var l=15+f.get(h).size,m=Math.sqrt(this.position.x*f.get(h).position.x+this.position.z*f.get(h).position.y);l>=m&&(this.av.y+=f.get(h).v/2)}for(var h=0;h<c.elements.length;h++){var g=Axis.z.clone().applyQuaternion(this.quaternion).setLength(54),E=Axis.z.clone().applyQuaternion(c.get(h).quaternion).setLength(c.get(h).size),y=this.position.clone().sub(g.clone().multiplyScalar(-.5)),x=c.get(h).position.clone().sub(E.clone().multiplyScalar(-.5));fly.colCup2D3(y,x,g,E,15+c.get(h).size)&&(u.explode(c.get(h).position,c.get(h).size,10),this.hp-=c.get(h).atk*i.difficulty,c.removeBullet(h))}for(var h=0;h<p.elements.length;h++){var g=Axis.z.clone().applyQuaternion(this.quaternion).setLength(54),E=Axis.z.clone().applyQuaternion(p.get(h).quaternion).setLength(p.get(h).size),y=this.position.clone().sub(g.clone().multiplyScalar(-.5)),x=p.get(h).position.clone().sub(E.clone().multiplyScalar(-.5));fly.colCup2D3(y,x,g,E,15+3*p.get(h).size)&&(u.explode(p.get(h).position,p.get(h).size,30),this.hp-=50*p.get(h).hp*i.difficulty/this.v,p.removeEnemy(h))}},sub:[function(){this.e>=250&&(this.s1c=20,this.rgl=2,this.e-=250,u.ray(this,16777215,.2,1,27,7),u.ray(this,65535,.2,2,27,5),u.ray(this,255,.2,4,27,3))}.bind(g),function(){this.e>=700&&(this.s2c=250,this.brl=17,this.e-=700,u.ray(this,16777215,.2,8,27,24),u.ray(this,16764108,.2,12,27,22),u.ray(this,16746632,.2,18,27,20),u.ray(this,16729156,.2,24,27,18),u.ray(this,16711680,.2,30,27,16))}.bind(g)],attack:function(e,t){var i=new THREE.Raycaster;i.set(this.position.clone(),Axis.z.clone().applyQuaternion(e).normalize());var s=i.intersectObjects(p.elements);0!==s.length&&(u.explode(s[0].point,1,10),s[0].object.hp-=5/t.difficulty)},beam:function(e,t,i,s,n){var a=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(0===s)var o=new THREE.Raycaster(this.position.clone(),a).intersectObjects(p.elements);else for(var o=[],r=0;r<p.elements.length;r++){var h=this.position.clone().add(a.multiplyScalar(27)),l=p.get(r).position,d=h.addScaledVector(a,h.clone().sub(l).negate().dot(a)/a.clone().dot(a)).sub(l).length();d<=s+5*p.get(r).size&&o.push({point:l.clone(),object:p.get(r)})}for(var r=0;r<o.length;r++)u.explode(o[r].point,t,i),o[r].object.hp-=e/n.difficulty}}),p.flyer=g,E.update=function(){this.move(g.position)},y.update=function(){this.position.x=g.position.x,this.position.z=g.position.z},e()}],[function(e){if("arcade"!==this.stage)var i=function(){for(var i=phina.asset.AssetManager.get("stage",this.stage).get(),s=0;s<i.enemys.length;s++)p.definedenemy[i.enemys[s].name]||p.defineEnemy(i.enemys[s].name),p.createEnemyMulti(i.enemys[s].name,i.enemys[s].option,i.enemys[s].autospawn,i.enemys[s].killmes);for(var s=0;s<i.winds.length;s++)f.createWind({v:i.winds[s].v,position:i.winds[s].position,size:i.winds[s].size},i.winds[s].color);for(var s=0;s<i.messages.length;s++)!i.messages[s].progress||i.messages[s].progress<1e-5?function(){var e=s;this.on("frame"+(i.messages[s].time-5),function(){l.text=""}.bind(this)),this.on("frame"+i.messages[s].time,function(){l.text=i.messages[e].text}.bind(this))}.bind(this)():function(){var e=s,t=function(){i.messages[e].progress<this.progress&&(this.on("frame"+(this.frame+i.messages[e].time-5),function(){l.text=""}.bind(this)),this.on("frame"+(this.frame+i.messages[e].time),function(){l.text=i.messages[e].text}.bind(this)),this.off("frame",t))}.bind(this);this.on("frame",t)}.bind(this)();var n=new THREE.ShaderMaterial({transparent:!0,uniforms:{tExplosion:{type:"t",value:phina.asset.AssetManager.get("threetexture","goal").get()},time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","goalvertexshader").get(),fragmentShader:phina.asset.AssetManager.get("text","expfragshader").get()});m=new THREE.Mesh(new THREE.IcosahedronGeometry(i.goal.size,2),n).$safe({update:function(){n.uniforms.time.value+=.005*Math.random()}}),m.move(new THREE.Vector3(i.goal.x,i.goal.y,i.goal.z)),t.scene.add(m);var a=g.position.x/15-m.position.x/15,o=g.position.z/15-m.position.z/15,r=Math.min(Math.sqrt(Math.pow(a,2)+Math.pow(o,2)),75),h=Math.atan2(a,o)-g.myrot.y+(Math.abs(g.myrot.x)>Math.PI/2&&Math.abs(g.myrot.x)<1.5*Math.PI?Math.PI:0);goalrader=phina.display.CircleShape({radius:5,fill:"hsla(190, 100%, 70%, 0.5)",stroke:"hsla(0, 0%, 0%, 0.5)",strokeWidth:1}).setPosition(SCREEN_WIDTH-100+Math.sin(h)*r,SCREEN_HEIGHT-100+Math.cos(h)*r),e()}.bind(this);if(phina.asset.AssetManager.get("stage",this.stage))i(),e();else{var s=phina.asset.AssetLoader(),n={stage:{}};n.stage[this.stage]="data/stages/"+this.stage+".min.json",s.load(n).then(function(){var e=phina.asset.AssetManager.get("stage",this.stage).get();n={threejson:{}};for(var t=0;t<e.enemys.length;t++)phina.asset.AssetManager.get("threejson",e.enemys[t].name)||(n.threejson[e.enemys[t].name]="data/models/"+p.enemys[e.enemys[t].name].filename+".min.json");s.onload=i,s.load(n)}.bind(this))}}],[function(e){t.addChildTo(this),i.addChildTo(this).setPosition(SCREEN_WIDTH-100,SCREEN_HEIGHT-100),s.addChildTo(this).setPosition(SCREEN_WIDTH-100,SCREEN_HEIGHT-100),s.rotation=180;for(var u=0;4>u;u++)n[u]=fly.DirectionShape({fill:"hsla(0, {0}%, {1}%, 0.5)".format(0===u?40:0,(0===u?10:0)+10),stroke:null,width:12,height:7.5}).addChildTo(this).setPosition(SCREEN_WIDTH-100-75*Math.sin(u*Math.PI/2),SCREEN_HEIGHT-100-75*Math.cos(u*Math.PI/2)),n[u].rotation=90*-u;a.addChildTo(this).setPosition(80,SCREEN_HEIGHT-100),a.animation=!1,o.addChildTo(this),o.animation=!1,o.setPosition(80,SCREEN_HEIGHT-80),"arcade"!==this.stage&&(goalrader.addChildTo(this),r.addChildTo(this).setPosition(SCREEN_CENTER_X,20),r.alpha=0,r.animation=!1,h.addChildTo(this).setPosition(0,SCREEN_HEIGHT),h.live=0,l.addChildTo(this).setPosition(0,SCREEN_HEIGHT)),d.addChildTo(this).setPosition(SCREEN_CENTER_X,SCREEN_HEIGHT-20),p.addChildTo(this),c.addChildTo(this),f.addChildTo(this),e()},function(e){var i=new THREE.DirectionalLight(16777215,1);i.position.set(0,0,30),y.rotate(-Math.PI/2,0,0),t.scene.add(i),t.scene.add(new THREE.AmbientLight(6316128)),t.scene.add(g),t.scene.add(E),t.scene.add(y),e()},function(e){t.update=function(e){var i=e.pointer,s=e.keyboard;if("arcade"===this.stage){var a=Math.random();if(a>.98&&p.count()<100){if(.995>a)var o="enem1";else if(.9975>a)var o="enem2";else var o="enem3";p.createEnemyMulti(o,{position:new THREE.Vector3(Math.randint(-500,500),Math.randint(500,5e3),Math.randint(-500,500)).add(g.position),quaternion:(new THREE.Quaternion).rotate(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2)},{random:{x:5,y:5,z:5}})}this.difficulty+=1e-4,p.count()>50&&p.removeEnemy(0)}else{this.progress=g.position.clone().dot(m.position)/m.position.clone().dot(m.position);var d=g.position.x/15-m.position.x/15,u=g.position.z/15-m.position.z/15,x=Math.min(Math.sqrt(Math.pow(d,2)+Math.pow(u,2)),75),v=Math.atan2(d,u)-g.myrot.y+(Math.abs(g.myrot.x)>Math.PI/2&&Math.abs(g.myrot.x)<1.5*Math.PI?Math.PI:0);goalrader.setPosition(SCREEN_WIDTH-100+Math.sin(v)*x,SCREEN_HEIGHT-100+Math.cos(v)*x),p.flare("frame",{progress:this.progress}),this.flare("frame")}for(var T=0;T<p.elements.length;T++)p.get(T).position.clone().sub(g.position).length>2e3&&p.removeEnemy(T);for(var T=0;T<c.elements.length;T++)c.get(T).position.clone().sub(g.position).length>800&&c.removeBullet(T);this.flare("frame"+this.frame),p.flare("frame"+this.frame),g.update(i,s,this),E.update(),y.update(),m.update(),f.flyerposy=g.position.y;for(var T=0;4>T;T++){var M=Math.abs(g.myrot.x)>Math.PI/2&&Math.abs(g.myrot.x)<1.5*Math.PI?1:0;n[T].setPosition(SCREEN_WIDTH-100-75*Math.sin(T*Math.PI/2-g.myrot.y+M*Math.PI),SCREEN_HEIGHT-100-75*Math.cos(T*Math.PI/2-g.myrot.y+M*Math.PI)),n[T].rotation=90*-T+g.myrot.y/Math.PI*180+180*M}t.camera.quaternion.copy(new THREE.Quaternion),t.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,-g.myrot.z2)),t.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,-g.myrot.x)),
t.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,g.myrot.y+Math.PI));var R=Axis.z.clone().applyQuaternion(t.camera.quaternion).negate().setLength(-100);t.camera.position.copy(g.position.clone().add(R)),t.camera.updateMatrixWorld(),this.bosscoming?(null===this.boss.parent?this.bosscoming=!1:r.value=this.boss.hp,r.alpha<.99999&&(r.alpha+=.1)):r.alpha>1e-5&&(r.alpha-=.1),s.getKeyDown(90)&&(l.text=""),""!==l.text?h.live<.99999&&(h.live+=.5,h.setPosition(SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live),h.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*h.live,h.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/8*h.live,l.setPosition(.2*SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live)):h.live>1e-5&&(h.live-=.5,h.setPosition(SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live),h.width=SCREEN_WIDTH/10+SCREEN_WIDTH/1.3*h.live,h.height=SCREEN_HEIGHT/12+SCREEN_HEIGHT/5*h.live,l.setPosition(.2*SCREEN_CENTER_X*h.live,SCREEN_HEIGHT-.3*SCREEN_CENTER_Y*h.live)),g.hp<=0&&("arcade"===this.stage?this.exit("gameover",{score:this.score}):this.exit("gameover",{score:this.score})),this.frame++}.bind(this),e()}]])}}),phina.define("fly.MainSequence",{superClass:"phina.game.ManagerScene",init:function(){this.superInit({scenes:[{className:"fly.LoadingScene",arguments:{lie:!1,assets:{threejson:{fighter:"data/models/fighter-1.min.json",bullet:"data/models/bullet.min.json"},threetexture:{explode:"data/images/explosion.png",goal:"data/images/goal.png",plane:"data/images/3.png"},threecubetex:{skybox:"data/images/skybox/ .png"},text:{expvertexshader:"data/glsl/expvertexshader.min.glsl",expfragshader:"data/glsl/expfragshader.min.glsl",goalvertexshader:"data/glsl/goalvertexshader.min.glsl"}}}},{label:"title",className:"fly.TitleScene",arguments:{title:"flight game",message:"Click start",fontColor:"#fff",exitType:"click"}},{label:"main",className:"fly.MainScene",arguments:{stage:"tutorial"}},{label:"gameover",className:"fly.GameOverScene"}]})}}),phina.define("fly.Application",{superClass:"phina.display.CanvasApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),threeext.extention(),this.replaceScene(fly.MainSequence())}}),phina.main(function(){var e=fly.Application();e.run()});