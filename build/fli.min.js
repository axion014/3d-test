var SCREEN_WIDTH=640,SCREEN_CENTER_X=320,SCREEN_HEIGHT=960,SCREEN_CENTER_Y=480,Axis={x:new THREE.Vector3(1,0,0).normalize(),y:new THREE.Vector3(0,1,0).normalize(),z:new THREE.Vector3(0,0,1).normalize()};
threeext={extention:function(){THREE.$extend({$extend:function(t,e){var o=Array.prototype.slice.call(arguments);return o.shift(),Array.prototype.forEach.call(o,function(o){for(var i in o)t[i]&&e[i]&&e[i].className&&"THREE."===e[i].className.substr(0,6)?t[i].copy(e[i]):t[i]=e[i]},this),t},$add:function(t,e){var o=Array.prototype.slice.call(arguments);return o.shift(),Array.prototype.forEach.call(o,function(o){for(var i in o)e[i]||(t[i]&&e[i]&&e[i].className&&"THREE."===e[i].className.substr(0,6)?t[i].add(e[i]):t[i]+=e[i])},this),t}}),THREE.Mesh.prototype.$safe({rotate:function(t,e,o){this.quaternion.rotate(t,e,o)},move:function(t){return this.position.x=t.x,this.position.y=t.y,this.position.z=t.z,this}}),THREE.Vector3.prototype.$safe({className:"THREE.Vector3"}),THREE.Quaternion.prototype.$safe({className:"THREE.Quaternion",rotate:function(t,e,o){if("THREE.Quaternion"===t.className){var i=t.clone();i.multiply(this.clone()),this.copy(i)}else this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,t)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,e)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,o));return this}}),THREE.PerspectiveCamera.prototype.$safe({rotate:function(t){var e=t.clone();e.multiply(this.quaternion.clone()),this.quaternion.copy(e)},move:function(t){this.position.x=t.x,this.position.y=t.y,this.position.z=t.z}})}};
phina.define("nfc.SimpleUpdater",{superClass:"phina.app.Element",init:function(){this.superInit(),this.elements=[]},update:function(){for(var e=0;e<this.elements.length;e++)this.elements[e].update()},get:function(e){return this.elements[e]},remove:function(e){this.elements.splice(e,1)},count:function(e){return this.elements.length}});
phina.define("nfc.DirectionShape",{superClass:"phina.display.Shape",init:function(i){i={}.$safe(i,{backgroundColor:"transparent",fill:"#ff5050",stroke:"#aaa",strokeWidth:2,radiusshort:16,radiuslong:32}),this.superInit(i)},render:function(i){i.clearColor(this.backgroundColor),i.transformCenter(),this.fill&&(i.context.fillStyle=this.fill,i.beginPath(),i.moveTo(0,this.radiuslong),i.lineTo(this.radiusshort,-this.radiuslong),i.lineTo(-this.radiusshort,-this.radiuslong),i.lineTo(0,this.radiuslong),i.closePath(),i.fill()),this.stroke&&0<this.strokeWidth&&(i.context.lineWidth=this.strokeWidth,i.strokeStyle=this.stroke,i.stroke())}});
phina.define("nfc.asset.ThreeJSON",{superClass:"phina.asset.Asset",data:null,init:function(){this.superInit()},_load:function(e){var s=this;(new THREE.JSONLoader).load(this.src,function(t,n){s.data=new THREE.Mesh(t,new THREE.MeshFaceMaterial(n)),e(s)})},get:function(){return this.data.clone()}}),phina.define("nfc.asset.ThreeTexture",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var s=this;(new THREE.TextureLoader).load(this.src,function(t){s._asset=t,e(s)})},get:function(){var e=this._asset.clone();return e.needsUpdate=!0,e}}),phina.define("nfc.asset.ThreeCubeTex",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var s=this,t=this.src.split(" ",2),n=[];for(i=0;i<6;i++)n[i]=t[0]+i+t[1];(new THREE.CubeTextureLoader).load(n,function(t){var n=THREE.ShaderLib.cube;n.uniforms.tCube.value=t,s._asset=new THREE.Mesh(new THREE.BoxGeometry(1e4,1e4,1e4),new THREE.ShaderMaterial({fragmentShader:n.fragmentShader,vertexShader:n.vertexShader,uniforms:n.uniforms,depthWrite:!1,side:THREE.BackSide})),e(s)})},get:function(){return this._asset.clone()}}),phina.define("nfc.asset.Text",{superClass:"phina.asset.Asset",_asset:null,init:function(){this.superInit()},_load:function(e){var s=this,t=new XMLHttpRequest;t.open("GET",this.src),t.onreadystatechange=function(){4===t.readyState&&(-1!==[200,201,0].indexOf(t.status)?(s._asset=t.response,e(s)):(s.loadError=!0,s.flare("loaderror"),404===t.status?(s.notFound=!0,s.flare("notfound")):(s.serverError=!0,s.flare("servererror")),reject(s)))},t.send(null)},get:function(){return this._asset}}),phina.define("nfc.asset.JSON",{superClass:"phina.asset.Asset",_asset:{},init:function(){this.superInit()},_load:function(e){var s=this,t=nfc.asset.Text();t.load(this.src).then(function(){this._asset=JSON.parse(t.get()),e(s)}.bind(this))},get:function(){return this._asset}}),phina.define("nfc.asset.Stage",{superClass:"phina.asset.Asset",data:[],init:function(){this.superInit()},_load:function(e){var s=this,t=nfc.asset.JSON();t.load(this.src).then(function(){for(var n=t.get(),a=0;a<n.enemys.length;a++)n.enemys[a].$safe({position:{},rotation:{},option:{},autospawn:{},random:{}}),n.enemys[a].position.$safe({x:0,y:0,z:0}),n.enemys[a].rotation.$safe({x:0,y:0,z:0,cx:0,cy:0,cz:0}),n.enemys[a].autospawn.$safe({time:0,progress:0}),n.enemys[a].option.$safe({position:new THREE.Vector3(n.enemys[a].position.x,n.enemys[a].position.y,n.enemys[a].position.z),quaternion:(new THREE.Quaternion).rotate(n.enemys[a].rotation.x,n.enemys[a].rotation.y,n.enemys[a].rotation.z),c:(new THREE.Quaternion).rotate(n.enemys[a].rotation.cx,n.enemys[a].rotation.cy,n.enemys[a].rotation.cz)});for(var a=0;a<n.winds.length;a++)n.winds[a].$safe({v:.2,x:0,y:0,color:[0,0,0]}),n.winds[a].position=new THREE.Vector2(n.winds[a].x,n.winds[a].y),n.winds[a].c=n.winds[a].color[0]<<16|n.winds[a].color[1]<<8|n.winds[a].color[2];n.goal.$safe({x:0,y:0,z:0,size:100}),this.data=n,e(s)}.bind(this))},get:function(){return this.data}}),phina.asset.AssetLoader.assetLoadFunctions.threejson=function(e,s){var t=nfc.asset.ThreeJSON(),n=t.load(s);return n},phina.asset.AssetLoader.assetLoadFunctions.threetexture=function(e,s){var t=nfc.asset.ThreeTexture(),n=t.load(s);return n},phina.asset.AssetLoader.assetLoadFunctions.threecubetex=function(e,s){var t=nfc.asset.ThreeCubeTex(),n=t.load(s);return n},phina.asset.AssetLoader.assetLoadFunctions.text=function(e,s){var t=nfc.asset.Text(),n=t.load(s);return n},phina.asset.AssetLoader.assetLoadFunctions.json=function(e,s){var t=nfc.asset.JSON(),n=t.load(s);return n},phina.asset.AssetLoader.assetLoadFunctions.stage=function(e,s){var t=nfc.asset.Stage(),n=t.load(s);return n};
nfc.colCup2D3=function(l,n,o,c,e){var a=n.clone().sub(l),t=c.clone().multiplyScalar(o.clone().dot(c)/c.clone().dot(c)).sub(o),d=t.clone().dot(t);if(1e-5>d){var u=n.clone().sub(l).length();u=Math.min(u,n.clone().add(c).sub(l).length()),u=Math.min(u,n.clone().sub(l.clone().add(o)).length()),u=Math.min(u,n.clone().add(c).sub(l.clone().add(o)).length());var h=n.clone().add(c.multiplyScalar(a.clone().dot(c)/c.clone().dot(c)*-1)),i=Math.min(u,h.sub(l).length())}else var m=c.clone().dot(c),r=Math.clamp(t.clone().dot(a.clone().dot(c)/m*c.clone().sub(a))/d,0,1),s=Math.clamp(o.clone().multiplyScalar(r).sub(a).dot(c)/m,0,1),i=n.clone().add(c.clone().multiplyScalar(s)).sub(l.clone().add(o.clone().multiplyScalar(r))).length();return e>=i};
phina.define("nfc.EffectManager",{superClass:"nfc.SimpleUpdater",init:function(e){this.superInit(),this.explodeManager=nfc.ExplodeManager(e).addChildTo(this),this.rayManager=nfc.RayManager(e).addChildTo(this),this.threescene=e},explode:function(e,t,n){return this.explodeManager.explode(e,t,n)},ray:function(e,t,n,a,i,s){return this.rayManager.ray(e,t,n,a,i,s)}}),phina.define("nfc.ExplodeManager",{superClass:"nfc.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},explode:function(e,t,n){var a=new THREE.ShaderMaterial({transparent:!0,uniforms:{tExplosion:{type:"t",value:phina.asset.AssetManager.get("threetexture","explode").get()},time:{type:"f",value:100*Math.random()},alpha:{type:"f",value:1}},vertexShader:phina.asset.AssetManager.get("text","expvertexshader").get(),fragmentShader:phina.asset.AssetManager.get("text","expfragshader").get()}),i=new THREE.Mesh(new THREE.IcosahedronGeometry(20,2),a).$safe({time:n,timeMax:n}).$safe({time:10,timeMax:10,update:function(){this.time--,a.uniforms.time.value+=.015*Math.random(),a.uniforms.alpha.value=this.time/this.timeMax}});return i.move(e),i.scale.set(t,t,t),this.threescene.add(i),this.elements.push(i),i},update:function(){for(var e=0;e<this.elements.length;e++)this.get(e).update(),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),e--)}}),phina.define("nfc.RayManager",{superClass:"nfc.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e},ray:function(e,t,n,a,i,s){var r=new THREE.Mesh(new THREE.SphereGeometry(a,20,10,0,2*Math.PI,0,Math.PI/2));r.position.set(0,-500,0);var h=new THREE.Mesh(new THREE.CylinderGeometry(a,a,1e3,20,10),new THREE.MeshBasicMaterial({color:t,opacity:n,transparent:!0})).$safe({time:s,timeMax:s,generator:e,length:500+i,update:function(){this.time--}});return h.geometry.merge(r.geometry),this.threescene.add(h),this.elements.push(h),h},update:function(){for(var e=0;e<this.count();e++)this.get(e).update(),this.get(e).move(this.get(e).generator.position.clone().add(Axis.z.clone().applyQuaternion(this.get(e).generator.quaternion).setLength(this.get(e).length))),this.get(e).quaternion.copy((new THREE.Quaternion).setFromAxisAngle(Axis.x,Math.PI/2)),this.get(e).quaternion.rotate(this.get(e).generator.quaternion),0===this.get(e).time&&(this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),e--)}});
phina.define("nfc.EnemyManager",{superClass:"nfc.SimpleUpdater",definedenemy:[],enemyraders:[],init:function(e,t,s){this.superInit(),this.scene=e,this.threescene=t,this.gauge_boss_h=s,this.effectmanager=new nfc.EffectManager(t).addChildTo(this)},defineEnemy:function(e,t,s){this.definedenemy[e]={mesh:phina.asset.AssetManager.get("threejson",e).get(),routine:t.$safe({hp:5,size:1,v:0,c:new THREE.Quaternion,time:0,update:function(){}}),autospawn:(s||{}).$safe({rep:1,options:{}})}},createEnemy:function(e,t,s,i){if(i){var n=function(h){h.progress>i&&(this.createEnemy(e,t,s),this.off("frame",n))}.bind(this);this.on("frame",n)}else{if(!s){var h=this.definedenemy[e].mesh.clone();THREE.$extend(h,this.definedenemy[e].routine),THREE.$extend(h,t),this.threescene.add(h),this.elements.push(h);var a=phina.display.CircleShape().addChildTo(this.scene);return a.radius=3,a.fill="hsla(0, 80%, 60%, 0.5)",a.stroke="hsla(0, 0%, 0%, 0.5)",a.strokeWidth=1,a.setPosition(SCREEN_WIDTH-100-this.flyer.position.x/10+h.position.x/10,SCREEN_HEIGHT-100-this.flyer.position.z/10+h.position.z/10),this.enemyraders.push(a),t.boss&&(this.scene.bosscoming=!0,this.scene.boss=h,this.gauge_boss_h.value=h.hp,this.gauge_boss_h.maxValue=h.hp),h}this.on("frame"+s,function(){this.createEnemy(e,t)}.bind(this))}},createEnemyMulti:function(e,t,s){for(var i=s.$safe(this.definedenemy[e].autospawn),n=0;n<i.rep;n++)this.createEnemy(e,t,i.time,i.progress),i.delay&&(i.time+=i.delay),THREE.$add(t,i.options),THREE.$add(t,i.random)},update:function(){for(var e=0;e<this.count();e++){this.get(e).update();var t=this.flyer.position.x/10-this.get(e).position.x/10,s=this.flyer.position.z/10-this.get(e).position.z/10,i=Math.sqrt(Math.pow(t,2)+Math.pow(s,2)),n=Math.atan2(t,s)-this.flyer.myrot.y;i=Math.min(i,75),this.enemyraders[e].setPosition(SCREEN_WIDTH-100+Math.sin(n)*i,SCREEN_HEIGHT-100+Math.cos(n)*i),this.get(e).hp<=0&&(this.effectmanager.explode(this.get(e).position,this.get(e).size,this.get(e).explodeTime),this.scene.score+=this.get(e).size,this.remove(e),e--)}},remove:function(e){this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1),this.enemyraders[e].remove(),this.enemyraders.splice(e,1)}});
phina.define("nfc.BulletManager",{superClass:"nfc.SimpleUpdater",init:function(e){this.superInit(),this.threescene=e,this.bullet=phina.asset.AssetManager.get("threejson","bullet").get()},createBullet:function(e){var t=this.bullet.clone();return THREE.$extend(t,e).$safe({v:1,size:1,atk:1,update:function(){this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v)}}),this.threescene.add(t),this.elements.push(t),t},update:function(){for(var e=0;e<this.count();e++)this.get(e).update()},remove:function(e){this.get(e).parent.remove(this.get(e)),this.elements.splice(e,1)}});
phina.define("nfc.WindManager",{superClass:"nfc.SimpleUpdater",time:0,flyerposy:0,init:function(t){this.superInit(),this.threescene=t},createWind:function(t,e){var s={v:.2,size:100,position:new THREE.Vector2,winds:[],update:function(){}}.$extend(t);s.mesh=THREE.$extend(new THREE.Mesh(new THREE.RingGeometry(s.size-.4,s.size,50,5),new THREE.MeshBasicMaterial({color:e,side:THREE.DoubleSide})),{position:new THREE.Vector3(s.position.x,0,s.position.y)});for(var i=-1e4*Math.sign(s.v);Math.abs(i)<=1e4;i+=300*s.v)s.winds.push(s.mesh.clone()),s.winds.last.rotate(Math.PI/2,0,0),s.winds.last.position.y=this.flyerposy+i,this.threescene.add(s.winds.last);return this.elements.push(s),s},update:function(){for(var t=0;t<this.count();t++){this.time%30===0&&(this.get(t).winds.push(this.get(t).mesh.clone()),this.get(t).winds.last.rotate(Math.PI/2,0,0),this.get(t).winds.last.position.y=this.flyerposy-1e4*Math.sign(this.get(t).v),this.threescene.add(this.get(t).winds.last)),this.get(t).winds.first&&this.get(t).winds.first.parent&&Math.abs(this.get(t).winds.first.position.y-this.flyerposy)>1e4&&this.get(t).winds.first.parent.remove(this.get(t).winds.first);for(var e=0;e<this.get(t).winds.length;e++)this.get(t).winds[e].position.y+=10*this.get(t).v}this.time++},remove:function(t){for(var e=0;e<this.get(t).winds.length;e++)this.get(t).winds[e].parent.remove(this.get(t).winds[e]);this.elements.splice(t,1)}});
phina.define("nfc.LoadingScene",{superClass:"phina.game.LoadingScene",init:function(i){i=(i||{}).$safe(nfc.LoadingScene.defaults).$safe(phina.game.LoadingScene.defaults),this.superInit(i),this.gauge.animationTime=i.animationtime},_static:{defaults:{animationtime:500}}});
phina.define("nfc.SplashLoadingScene",{superClass:"phina.display.CanvasScene",init:function(e){e=(e||{}).$safe(phina.game.LoadingScene.defaults),this.superInit(e);var i=phina.asset.Texture();i.load(phina.game.SplashScene.defaults.imageURL).then(function(){this.sprite=phina.display.Sprite(this.texture).addChildTo(this),this.sprite.setPosition(this.gridX.center(),this.gridY.center()),this.sprite.alpha=0,this.sprite.tweener.clear().to({alpha:1},500,"easeOutCubic").wait(1e3).to({alpha:0},500,"easeOutCubic").wait(250).call(function(){this.sprite.remove()},this)}.bind(this)),this.texture=i;var t=phina.asset.AssetLoader();t.onload=function(e){this.app.popScene()}.bind(this),t.load(e.assets)}});
phina.define("nfc.SceneLoadingScene",{superClass:"phina.display.CanvasScene",init:function(i){i=(i||{}).$safe(nfc.SceneLoadingScene.defaults),this.superInit(i),this.options=i},load:function(i,n){n|=0,0===n&&(this.label=phina.display.Label({text:"Loading... 0%",fill:"hsla(0, 0%, 0%, 0.6)",fontSize:12}),this.label.setPosition({x:SCREEN_CENTER_X,y:SCREEN_CENTER_Y}));var e=phina.util.Flow(i[n].bind(this));e.then(function(){this.label.text="Loading... "+ ++n/i.length*100+"%",n<i.length?this.load(i,n):this.removeChild(this.label)}.bind(this))},_static:{defaults:{animationTime:100}}});
phina.define("nfc.TitleScene",{superClass:"phina.game.TitleScene",bgbright:64,init:function(i){this.superInit(i),this.fromJSON({children:{messageLabel:{className:"phina.display.Label",arguments:{text:i.message,fill:i.fontColor,stroke:!1,fontSize:24},x:this.gridX.center(),y:this.gridY.span(12)}}}),this.on("pointstart",function(){this.clicked=!0})},update:function(){this.clicked&&(100===this.bgbright&&this.exit(),this.bgbright+=4,this.backgroundColor="hsl(200, 80%, "+this.bgbright+"%)")}});
phina.define("nfc.GameOverScene",{superClass:"phina.display.CanvasScene",init:function(e){this.superInit(e),e=(e||{}).$safe(phina.game.ResultScene.defaults);e.message.format(e);this.backgroundColor=e.backgroundColor,this.fromJSON({children:{scoreText:{className:"phina.display.Label",arguments:{text:"score",fill:e.fontColor,stroke:null,fontSize:48},x:this.gridX.center(),y:this.gridY.span(4)},scoreLabel:{className:"phina.display.Label",arguments:{text:""+e.score,fill:e.fontColor,stroke:null,fontSize:72},x:this.gridX.center(),y:this.gridY.span(6)},playButton:{className:"phina.ui.Button",arguments:[{text:"retry",width:144,height:144,fontSize:45,cornerRadius:72}],x:this.gridX.center(),y:this.gridY.span(12),interactive:!0,onpush:function(){this.exit("main")}.bind(this)}}})}});
phina.define("nfc.MainScene",{superClass:"nfc.SceneLoadingScene",frame:0,stage:"arcade",difficulty:1,progress:0,score:0,init:function(t){t.stage&&(this.stage=t.stage),t.difficulty&&(this.difficulty=t.difficulty),this.superInit();var e,i,s,n,a,o,r,h,l,c,p,d,u,g,m=phina.display.ThreeLayer({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}).addChildTo(this),E=[];this.load([function(t){var e=new THREE.DirectionalLight(16777215,1);e.position.set(0,0,30),m.scene.add(e),m.scene.add(new THREE.AmbientLight(6316128)),l=phina.display.CircleShape().addChildTo(this),l.radius=75,l.fill="hsla(0, 0%, 30%, 0.5)",l.stroke=null,l.setPosition(SCREEN_WIDTH-100,SCREEN_HEIGHT-100),c=nfc.DirectionShape().addChildTo(this),c.fill="hsla(0, 50%, 70%, 0.5)",c.stroke="hsla(0, 0%, 0%, 0.5)",c.strokeWidth=1,c.radiusshort=2.5,c.radiuslong=4,c.setPosition(SCREEN_WIDTH-100,SCREEN_HEIGHT-100),c.rotation=180;for(var i=0;4>i;i++)E[i]=nfc.DirectionShape().addChildTo(this),0===i?E[i].fill="hsla(0, 40%, 20%, 0.5)":E[i].fill="hsla(0, 0%, 10%, 0.5)",E[i].stroke=null,E[i].radiusshort=12,E[i].radiuslong=7.5,E[i].setPosition(SCREEN_WIDTH-100-75*Math.sin(i*Math.PI/2),SCREEN_HEIGHT-100-75*Math.cos(i*Math.PI/2)),E[i].rotation=90*-i;p=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(255, 64, 64, 0.3)",value:1e3,maxValue:1e3,strokeWidth:1,width:128,height:16}).addChildTo(this),p.animation=!1,p.setPosition(80,SCREEN_HEIGHT-100),d=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(64, 64, 255, 0.3)",value:1e3,maxValue:1e3,strokeWidth:1,width:128,height:16}).addChildTo(this),d.animation=!1,d.setPosition(80,SCREEN_HEIGHT-80),u=phina.ui.Gauge({fill:"rgba(0, 0, 0, 0)",gaugeColor:"rgba(200, 16, 16, 0.3)",strokeWidth:1,width:SCREEN_WIDTH/1.2,height:16}).addChildTo(this),u.alpha=0,u.animation=!1,u.setPosition(SCREEN_CENTER_X,20),g=phina.display.Label({text:"speed: 1",fontSize:16,fill:"hsla(0, 0%, 0%, 0.6)"}).addChildTo(this),g.setPosition(SCREEN_CENTER_X,SCREEN_HEIGHT-20),t()},function(t){e=nfc.EnemyManager(this,m.scene,u).addChildTo(this),i=e.effectmanager,s=nfc.BulletManager(m.scene).addChildTo(this),n=nfc.WindManager(m.scene).addChildTo(this),t()},function(t){a=phina.asset.AssetManager.get("threejson","fighter").get(),r=phina.asset.AssetManager.get("threecubetex","skybox").get(),h=new THREE.Mesh(new THREE.PlaneGeometry(1e4,1e4),new THREE.MeshBasicMaterial({map:phina.asset.AssetManager.get("threetexture","plane").get()})),h.rotate(-Math.PI/2,0,0),a.position.y=1e3,a.transparent=!0,a.opacity=.3,a.$safe({speeds:[.15,.3,.5,1],myrot:{x:0,y:0,z1:0,z2:0},row:0,yo:0,v:0,rgc:0,brc:0,sc:0,e:1e3,hp:1e3,speed:0,ups:15e-5,av:new THREE.Vector3,update:function(t,a,o){var r=0;if(t.getPointing()&&(this.e--,this.v+=this.speeds[this.speed],r=t.x-SCREEN_CENTER_X,this.myrot.z1+=8e-5*r,this.yo+=8e-5*r,this.row+=(t.y-SCREEN_CENTER_Y)*this.ups),a.getKeyDown(67)&&(this.speed++,this.speed%=4,g.text="speed: "+(this.speed+1)),this.myrot.x+=.1*this.row,this.myrot.y-=.1*this.yo,this.myrot.x%=2*Math.PI,this.quaternion.copy(new THREE.Quaternion),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,this.myrot.z1+this.myrot.z2)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,this.myrot.x)),this.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,this.myrot.y)),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.position.add(this.av),this.av.multiplyScalar(.98),this.myrot.z1*=.95,a.getKey(16)||Math.abs(this.myrot.x)<Math.PI/2||Math.abs(this.myrot.x)>1.5*Math.PI?(this.ups<15e-5&&(this.ups+=1e-5),this.myrot.z2*=.95):(this.ups>-15e-5&&(this.ups-=1e-5),this.myrot.z2+=.05*(Math.PI-this.myrot.z2)),this.yo*=.95,this.row*=.9,this.v*=.98-6e-5*Math.abs(r)-(a.getKey(66)?.05:0),this.e>0){if(a.getKey(32)&&0===this.sc){this.e-=2;var h=this.quaternion.clone();h.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,.06*Math.random()-.03)),h.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,.06*Math.random()-.03));var l=this.quaternion.clone();l.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,.06*Math.random()-.03)),l.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,.06*Math.random()-.03)),this.attack(h,o),this.attack(l,o)}a.getKeyDown(65)&&0===this.rgc&&this.e>=250?(this.rgc=20,this.rgl=2,this.e-=250,this.beam(40,2,15,0,o),i.ray(this,16777215,.2,1,27,7),i.ray(this,65535,.2,2,27,5),i.ray(this,255,.2,4,27,3)):this.rgl>0&&(this.rgl--,this.beam(30,2,15,0,o)),a.getKeyDown(83)&&0===this.brc&&this.e>=700?(this.brc=250,this.brl=17,this.rgc=80,this.sc=50,this.e-=700,this.beam(100,3,25,30,o),i.ray(this,16777215,.2,8,27,24),i.ray(this,16764108,.2,12,27,22),i.ray(this,16746632,.2,18,27,20),i.ray(this,16729156,.2,24,27,18),i.ray(this,16711680,.2,30,27,16)):this.brl>0&&(this.brl--,this.beam(25,3,25,30,o))}this.rgc>0&&this.rgc--,this.brc>0&&this.brc--,this.sc>0&&this.sc--,d.value=this.e,this.e<1e3&&(this.e+=4),p.value=this.hp;for(var c=0;c<n.elements.length;c++){var u=15+n.get(c).size,m=Math.sqrt(this.position.x*n.get(c).position.x+this.position.z*n.get(c).position.y);u>=m&&(this.av.y+=n.get(c).v/2)}for(var c=0;c<s.elements.length;c++){var E=Axis.z.clone().applyQuaternion(this.quaternion).setLength(54),y=Axis.z.clone().applyQuaternion(s.get(c).quaternion).setLength(s.get(c).size),f=this.position.clone().sub(E.clone().multiplyScalar(-.5)),x=s.get(c).position.clone().sub(y.clone().multiplyScalar(-.5));nfc.colCup2D3(f,x,E,y,15+s.get(c).size)&&(i.explode(s.get(c).position,s.get(c).size,10),this.hp-=s.get(c).atk*o.difficulty,s.remove(c))}for(var c=0;c<e.elements.length;c++){var E=Axis.z.clone().applyQuaternion(this.quaternion).setLength(54),y=Axis.z.clone().applyQuaternion(e.get(c).quaternion).setLength(e.get(c).size),f=this.position.clone().sub(E.clone().multiplyScalar(-.5)),x=e.get(c).position.clone().sub(y.clone().multiplyScalar(-.5));nfc.colCup2D3(f,x,E,y,15+3*e.get(c).size)&&(i.explode(e.get(c).position,e.get(c).size,30),this.hp-=50*e.get(c).hp*o.difficulty/this.v,e.remove(c))}},attack:function(t,s){var n=new THREE.Raycaster;n.set(this.position.clone(),Axis.z.clone().applyQuaternion(t).normalize());var a=n.intersectObjects(e.elements);0!==a.length&&(i.explode(a[0].point,1,10),a[0].object.hp-=5/s.difficulty)},beam:function(t,s,n,a,o){var r=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(0===a)var h=new THREE.Raycaster(this.position.clone(),r).intersectObjects(e.elements);else for(var h=[],l=0;l<e.elements.length;l++){var c=this.position.clone().add(r.multiplyScalar(27)),p=e.get(l).position,d=c.addScaledVector(r,c.clone().sub(p).negate().dot(r)/r.clone().dot(r)).sub(p).length();d<=a+5*e.get(l).size&&h.push({point:p.clone(),object:e.get(l)})}for(var l=0;l<h.length;l++)i.explode(h[l].point,s,n),h[l].object.hp-=t/o.difficulty}}),e.flyer=a,r.update=function(){this.move(a.position)},h.update=function(){this.position.x=a.position.x,this.position.z=a.position.z},t()},function(t){e.defineEnemy("enem1",{v:.6,duration:100,update:function(){this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.duration===0&&s.createBullet({position:this.position,quaternion:this.quaternion,v:2,atk:70}),this.quaternion.rotate(this.c),this.time++}},{rep:6,delay:15}),e.defineEnemy("enem2",{hp:45,v:1,size:15,chase:.1,mindist:500,duration:15,explodeTime:30,update:function(){if(!a.position.equals(this.position)){var t=a.position.clone().sub(this.position.clone()),e=this.v*Math.clamp(2*(t.length()-this.mindist)/this.mindist,-1,1);t.normalize(),this.quaternion.slerp((new THREE.Quaternion).setFromAxisAngle(Axis.z.clone().cross(t).normalize(),Math.acos(Axis.z.clone().dot(t))),this.chase),this.position.addScaledVector(t,e)}this.time%this.duration===0&&s.createBullet({position:this.position,quaternion:this.quaternion,v:3,size:1.5,atk:100}),this.time++}},{}),e.defineEnemy("enem3",{hp:500,v:.25,size:30,duration:3,r:.1,explodeTime:30,scale:new THREE.Vector3(2,2,2),update:function(){this.rotate(this.c);var t=Axis.z.clone().applyQuaternion(this.quaternion).normalize();if(this.rotate((new THREE.Quaternion).setFromAxisAngle(t,this.r)),this.position.addScaledVector(Axis.z.clone().applyQuaternion(this.quaternion).normalize(),this.v),this.time%this.duration===0){var e=this.quaternion.clone().rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,Math.PI/2));s.createBullet({position:this.position,quaternion:this.quaternion.clone().rotate((new THREE.Quaternion).setFromAxisAngle(e,Math.PI*(this.time%(8*this.duration))/this.duration/8)),size:.5,atk:50})}this.time++}},{}),t()},function(t){if("arcade"===this.stage||phina.asset.AssetManager.get("stage",this.stage))t();else{var e=phina.asset.AssetLoader();e.onload=function(e){t()};var i={stage:{}};i.stage[this.stage]="data/stages/"+this.stage+".min.json",e.load(i)}},function(t){if(m.scene.add(a),m.scene.add(r),m.scene.add(h),"arcade"!==this.stage){for(var i=phina.asset.AssetManager.get("stage",this.stage).get(),s=0;s<i.enemys.length;s++)e.createEnemyMulti(i.enemys[s].name,i.enemys[s].option,i.enemys[s].autospawn);for(var s=0;s<i.winds.length;s++)n.createWind({v:i.winds[s].v,position:i.winds[s].position,size:i.winds[s].size},i.winds[s].color);o=new THREE.Mesh(new THREE.IcosahedronGeometry(i.goal.size,2),new THREE.Material),o.move(new THREE.Vector3(i.goal.x,i.goal.y,i.goal.z))}t()},function(t){m.update=function(t){var i=t.pointer,l=t.keyboard;if("arcade"===this.stage){var c=Math.random();if(c>.98&&e.count()<100){if(.995>c)var p="enem1";else if(.9975>c)var p="enem2";else var p="enem3";e.createEnemyMulti(p,{position:new THREE.Vector3(Math.randint(-500,500),Math.randint(500,5e3),Math.randint(-500,500)).add(a.position),quaternion:(new THREE.Quaternion).rotate(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2)},{options:{position:function(){return new THREE.Vector3(10*Math.random()-5,10*Math.random()-5,10*Math.random()-5)}}})}this.difficulty+=1e-4,e.count()>50&&e.remove(0)}else this.progress=a.position.clone().dot(o.position)/o.position.clone().dot(o.position),e.flare("frame",{progress:this.progress});for(var d=0;d<e.elements.length;d++)e.get(d).position.clone().sub(a.position).length>2e3&&e.remove(d);for(var d=0;d<s.elements.length;d++)s.get(d).position.clone().sub(a.position).length>800&&s.remove(d);e.flare("frame"+this.frame),a.update(i,l,this),r.update(),h.update(),n.flyerposy=a.position.y;for(var d=0;4>d;d++)E[d].setPosition(SCREEN_WIDTH-100-75*Math.sin(d*Math.PI/2-a.myrot.y),SCREEN_HEIGHT-100-75*Math.cos(d*Math.PI/2-a.myrot.y)),E[d].rotation=90*-d+a.myrot.y/Math.PI*180;m.camera.quaternion.copy(new THREE.Quaternion),m.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.z,-a.myrot.z2)),m.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.x,-a.myrot.x)),m.camera.rotate((new THREE.Quaternion).setFromAxisAngle(Axis.y,a.myrot.y+Math.PI));var g=Axis.z.clone().applyQuaternion(m.camera.quaternion).negate().setLength(-100);m.camera.position.copy(a.position.clone().add(g)),m.camera.updateMatrixWorld(),this.bosscoming?(null===this.boss.parent?this.bosscoming=!1:u.value=this.boss.hp,u.alpha<.99999&&(u.alpha+=.1)):u.alpha>1e-5&&(u.alpha-=.1),a.hp<=0&&("arcade"===this.stage?this.exit("gameover",{score:this.score}):this.exit("gameover",{score:this.score})),this.frame++}.bind(this),t()}])}});
phina.define("nfc.MainSequence",{superClass:"phina.game.ManagerScene",init:function(){this.superInit({scenes:[{className:"nfc.LoadingScene",arguments:{lie:!1,assets:{threejson:{fighter:"data/models/fighter-1.min.json",enem1:"data/models/enem-1.min.json",enem2:"data/models/fighter-2.min.json",enem3:"data/models/enem-3.min.json",bullet:"data/models/bullet.min.json"},threetexture:{explode:"data/explosion.png",plane:"data/3.png"},threecubetex:{skybox:"data/skybox/ .png"},text:{expvertexshader:"data/glsl/expvertexshader.min.glsl",expfragshader:"data/glsl/expfragshader.min.glsl"},stage:{tutorial:"data/stages/tutorial.min.json"}}}},{label:"title",className:"nfc.TitleScene",arguments:{title:"flight game",message:"Click start",fontColor:"#fff",exitType:"click"}},{label:"main",className:"nfc.MainScene",arguments:{stage:"tutorial"}},{label:"gameover",className:"nfc.GameOverScene"}]})}}),phina.define("nfc.Application",{superClass:"phina.display.CanvasApp",init:function(){this.superInit({width:SCREEN_WIDTH,height:SCREEN_HEIGHT}),threeext.extention(),this.replaceScene(nfc.MainSequence())}}),phina.main(function(){var e=nfc.Application();e.run()});